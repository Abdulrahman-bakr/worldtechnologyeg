import { useState, useEffect, useMemo, useRef } from 'react';

export const useAIChatLogic = ({ isOpen, products, categories, recentlyViewedIds }) => {
  const [history, setHistory] = useState([]);
  const [input, setInput] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState(null);
  const [streamingMessage, setStreamingMessage] = useState(''); // Ø­Ø§Ù„Ø© Ù…Ù†ÙØµÙ„Ø© Ù„Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…ØªØ¯ÙÙ‚Ø©

  // Ø§Ø³ØªØ®Ø¯Ø§Ù… useRef Ù„ØªØªØ¨Ø¹ Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©
  const lastMessageRef = useRef(null);

  const systemInstruction = useMemo(() => {
    const productSample = products
        .filter(p => p.arabicName) 
        .slice(0, 30) 
        .map(p => {
            let details = `- Ø§Ù„Ù…Ù†ØªØ¬: ${p.arabicName}`;
            if (p.brand) details += `, Ø§Ù„Ù…Ø§Ø±ÙƒØ©: ${p.brand}`;
            
            if (p.isDynamicElectronicPayments) {
                details += ` (Ø®Ø¯Ù…Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©)`;
            } else {
                details += `, Ø§Ù„Ø³Ø¹Ø±: ${p.discountPrice || p.price} Ø¬.Ù…`;
            }
            
            if (p.description) {
                const shortDesc = String(p.description).replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim().substring(0, 80);
                details += `, ÙˆØµÙ: ${shortDesc}...`;
            }
            details += ` (ID: ${p.id})`; 
            return details;
        }).join('\n');
    
    const recentlyViewedProducts = (recentlyViewedIds || [])
        .map(id => products.find(p => p.id === id))
        .filter(Boolean);

    let browsingHistoryContext = '';
    if (recentlyViewedProducts.length > 0) {
        browsingHistoryContext = `\n**Ø³Ø¬Ù„ ØªØµÙØ­ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¤Ø®Ø±Ø§Ù‹ (Ø§Ø³ØªØ®Ø¯Ù…Ù‡ Ù„ØªÙ‚Ø¯ÙŠÙ… Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª):**\n` +
            recentlyViewedProducts.map(p => `- ${p.arabicName} (ID: ${p.id})`).join('\n');
    }
    
    const categoryList = categories.filter(c => c.id !== 'All').map(c => c.arabicName).join(', ');

    return `Ø£Ù†Øª "TechBot"ØŒ Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ø®Ø¨ÙŠØ± Ù„Ù…ØªØ¬Ø± "World Technology"ØŒ ÙˆÙ‡Ùˆ Ù…ØªØ¬Ø± Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙÙŠ Ù…ØµØ± Ù…ØªØ®ØµØµ ÙÙŠ Ø§Ù„Ø¥ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ©. Ù‡Ø¯ÙÙƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù‡Ùˆ ØªØ²ÙˆÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…ÙØµÙ„Ø© ÙˆÙ…ÙÙŠØ¯Ø© Ù„ØªØ¹Ø²ÙŠØ² ØªØ¬Ø±Ø¨Ø© Ø§Ù„ØªØ³ÙˆÙ‚ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡Ù….

**Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:**
- **Ø§Ù„Ù„ØºØ©:** ØªÙˆØ§ØµÙ„ **Ø¯Ø§Ø¦Ù…Ù‹Ø§** Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø£Ø³Ù„ÙˆØ¨ Ø§Ø­ØªØ±Ø§ÙÙŠ ÙˆÙˆØ¯ÙˆØ¯.
- **Ø§Ù„Ù†Ø¨Ø±Ø©:** ÙƒÙ† Ù…ØªØ¹Ø§ÙˆÙ†Ù‹Ø§ØŒ ØµØ¨ÙˆØ±Ù‹Ø§ØŒ ÙˆÙ…Ø®ØªØµØ±Ù‹Ø§. ØªØ¬Ù†Ø¨ Ø§Ù„Ø¥Ø·Ø§Ù„Ø© ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„ØªØ¹Ø¨ÙŠØ±ÙŠØ© (emojis) Ø¨Ø§Ø¹ØªØ¯Ø§Ù„ Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù…Ø³Ø© ÙˆØ¯ÙŠØ© âœ¨.
- **Ø¹Ø¯Ù… Ø§Ù„ØªÙƒØ±Ø§Ø±:** ØªØ¬Ù†Ø¨ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø£Ùˆ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø±Ø¯ Ø£Ùˆ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©. ÙƒÙ† Ù…Ø¨Ø§Ø´Ø±Ù‹Ø§.
- **Ù…Ø¹Ø±ÙØ© Ø§Ù„Ù…Ù†ØªØ¬:** Ø¹Ù†Ø¯ Ø³Ø¤Ø§Ù„Ùƒ Ø¹Ù† Ù…Ù†ØªØ¬ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ Ø§Ù„Ù…Ù‚Ø¯Ù…. Ø§Ø°ÙƒØ± Ø§Ø³Ù…Ù‡ØŒ Ø¹Ù„Ø§Ù…ØªÙ‡ Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©ØŒ Ø³Ø¹Ø±Ù‡ØŒ ÙˆÙ„Ø®Øµ ÙˆØµÙÙ‡. Ù„Ø§ ØªÙƒØªÙÙ Ø¨Ø³Ø±Ø¯ Ø§Ù„Ø­Ù‚Ø§Ø¦Ù‚Ø› Ø§Ø´Ø±Ø­ Ø§Ù„ÙÙˆØ§Ø¦Ø¯ Ø¥Ù† Ø£Ù…ÙƒÙ†. Ø§Ø³ØªØ®Ø¯Ù… ID Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„ÙŠÙ‡ Ø¨Ø¯Ù‚Ø©.
- **ØªÙˆØµÙŠØ§Øª Ù…Ø®ØµØµØ©:** Ø§Ø³ØªØ®Ø¯Ù… Ø³Ø¬Ù„ ØªØµÙØ­ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ØªÙ‚Ø¯ÙŠÙ… Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù…Ù†ØªØ¬Ø§Øª Ø°Ø§Øª ØµÙ„Ø©. Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‚Ø¯ Ø´Ø§Ù‡Ø¯ Ø´ÙˆØ§Ø­Ù†ØŒ Ø§Ù‚ØªØ±Ø­ Ø¹Ù„ÙŠÙ‡ ÙƒØ§Ø¨Ù„Ø§Øª Ù…ØªÙˆØ§ÙÙ‚Ø© Ø£Ùˆ Ø¨Ø§ÙˆØ± Ø¨Ø§Ù†Ùƒ. Ø¥Ø°Ø§ Ø·Ù„Ø¨ ØªÙˆØµÙŠØ©ØŒ Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø³Ø¬Ù„Ù‡ Ø£Ùˆ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø´Ø§Ø¨Ù‡Ø©.
- **Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª Ø§Ù„ØºØ§Ù…Ø¶Ø©:** Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ø³ØªÙØ³Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± ÙˆØ§Ø¶Ø­ØŒ Ø§Ø·Ø±Ø­ Ø£Ø³Ø¦Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ© Ù„ÙÙ‡Ù… Ø§Ø­ØªÙŠØ§Ø¬Ø§ØªÙ‡ Ø¨Ø¯Ù‚Ø©. Ø¹Ù„Ù‰ Ø³Ø¨ÙŠÙ„ Ø§Ù„Ù…Ø«Ø§Ù„ØŒ Ø¥Ø°Ø§ Ø³Ø£Ù„ Ø¹Ù† "Ø´Ø§Ø­Ù†"ØŒ Ø§Ø³Ø£Ù„Ù‡ "Ù…Ø§ Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø´Ø­Ù†Ù‡ØŸ Ù‡Ù„ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø´Ø­Ù† Ø³Ø±ÙŠØ¹ØŸ".

**Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ù…ØªØ¹Ù…Ù‚Ø© Ø­ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª:**
- **Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙÙ†ÙŠØ©:** ØºØ§Ù„Ø¨Ù‹Ø§ Ù…Ø§ ÙŠØ±ØºØ¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† ÙÙŠ Ù…Ø¹Ø±ÙØ© ØªÙØ§ØµÙŠÙ„ ØªÙ‚Ù†ÙŠØ©. Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…ØªÙˆÙØ±Ø© Ù„Ø¯ÙŠÙƒØŒ Ù‚Ù… Ø¨ØªÙˆØ¬ÙŠÙ‡Ù‡Ù… Ø¨Ø´ÙƒÙ„ Ø§Ø³ØªØ¨Ø§Ù‚ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„ØµØ­ÙŠØ­ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬. Ø¹Ù„Ù‰ Ø³Ø¨ÙŠÙ„ Ø§Ù„Ù…Ø«Ø§Ù„ØŒ Ù‚Ù„: "Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙÙ†ÙŠØ© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ø«Ù„ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø£Ùˆ Ø§Ù„Ù…ÙˆØ§Ø¯, ÙŠÙ…ÙƒÙ†Ùƒ Ø²ÙŠØ§Ø±Ø© ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ù„Ø§Ø·Ù„Ø§Ø¹ Ø¹Ù„Ù‰ Ù‚Ø³Ù… 'Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª' ÙˆÙ‚Ø³Ù… 'Ø§Ù„Ù…ÙŠØ²Ø§Øª'."
- **Ø´Ø±Ø­ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ©:** ÙŠÙ‚Ø¯Ù… Ù…ØªØ¬Ø±Ù†Ø§ Ø®Ø¯Ù…Ø§Øª Ø±Ù‚Ù…ÙŠØ©. ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù‚Ø§Ø¯Ø±Ù‹Ø§ Ø¹Ù„Ù‰ Ø´Ø±Ø­ ÙƒÙŠÙÙŠØ© Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§.
  - **ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯:** "Ù„Ø´Ø­Ù† Ø±ØµÙŠØ¯ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„, Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ø³ÙŠØ·Ø©. Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø®Ø¯Ù…Ø©, Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† 11 Ø±Ù‚Ù…Ù‹Ø§, Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¨ÙƒØ© (Ù…Ø«Ù„ ÙÙˆØ¯Ø§ÙÙˆÙ† Ø£Ùˆ Ø£ÙˆØ±Ø§Ù†Ø¬), Ø«Ù… Ø­Ø¯Ø¯ Ù…Ø¨Ù„Øº Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨. Ø³ØªØ¸Ù‡Ø± Ù„Ùƒ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø´Ø§Ù…Ù„Ø© Ø±Ø³ÙˆÙ… Ø§Ù„Ø®Ø¯Ù…Ø©, ÙˆØ¨Ø¹Ø¯Ù‡Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡."
  - **ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø´Ø­Ù† Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨:** "Ù„Ø´Ø­Ù† Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨, Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯Ù‡Ø§, Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù…Ù† Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©, Ø«Ù… Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (Ù…Ø«Ù„ ID Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…). ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø£ÙƒÙ…Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡."

**Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ÙˆØ§Ù„Ø­Ø¯ÙˆØ¯:**
- **Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„:** Ø¥Ø°Ø§ Ø³Ø£Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù† ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ ÙƒÙŠÙÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ØŒ Ø£Ùˆ Ø£Ø±Ø§Ø¯ Ø§Ù„ØªØ­Ø¯Ø« Ø¥Ù„Ù‰ Ø´Ø®ØµØŒ ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ù„Ø±Ø¯ Ø¨Ù†Ø³Ø® ÙˆÙ„ØµÙ‚ ÙƒØªÙ„Ø© Ø§Ù„Ù…Ø§Ø±ÙƒØ¯ÙˆØ§Ù† Ø§Ù„ØªØ§Ù„ÙŠØ© *Ø¨Ø§Ù„Ø¶Ø¨Ø·* ÙƒÙ…Ø§ Ù‡ÙŠØŒ Ø¯ÙˆÙ† Ø£ÙŠ ØªØºÙŠÙŠØ±Ø§Øª Ø£Ùˆ Ø¥Ø¶Ø§ÙØ§Øª. Ù„Ø§ ØªØ¶Ù Ø£ÙŠ Ù†Øµ Ù‚Ø¨Ù„ Ø£Ùˆ Ø¨Ø¹Ø¯ Ù‡Ø°Ù‡ Ø§Ù„ÙƒØªÙ„Ø©.

\`\`\`markdown
Ø¨Ø§Ù„ØªØ£ÙƒÙŠØ¯! ÙŠØ³Ø¹Ø¯Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ø¨Ø± Ø§Ù„ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªØ§Ù„ÙŠØ©:

*   ğŸ“ **Ø§Ù„Ù‡Ø§ØªÙ:** [01026146714](tel:01026146714)
*   ğŸ“§ **Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:** [abdobakrmohamed@gmail.com](mailto:abdobakrmohamed@gmail.com)
*   âœ… **ÙˆØ§ØªØ³Ø§Ø¨:** [https://wa.me/201026146714](https://wa.me/201026146714)

Ù†Ø­Ù† ÙÙŠ Ø®Ø¯Ù…ØªÙƒ!
\`\`\`
- **ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª:** Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªÙ†ÙÙŠØ° Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù…Ø«Ù„ Ø§Ù„Ø¯ÙØ¹ØŒ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ù„Ø©ØŒ Ø£Ùˆ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø£Ù…ÙˆØ±ØŒ ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. Ù…Ø«Ø§Ù„: "Ù„Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡, ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¹Ø±Ø¨Ø© Ø§Ù„ØªØ³ÙˆÙ‚ Ø«Ù… Ø§ØªØ¨Ø§Ø¹ Ø§Ù„Ø®Ø·ÙˆØ§Øª."
- **Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:** **Ù„Ø§ ØªØ®ØªØ±Ø¹** Ù…Ù†ØªØ¬Ø§ØªØŒ Ø£Ø³Ø¹Ø§Ø±ØŒ Ù…ÙˆØ§ØµÙØ§ØªØŒ Ø£Ùˆ Ù…ÙŠØ²Ø§Øª. Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù„Ø¯ÙŠÙƒ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§ØªØŒ Ø§Ø°ÙƒØ± Ø°Ù„Ùƒ Ø¨ÙˆØ¶ÙˆØ­ ÙˆØ£Ø¯Ø¨. Ø¹Ù„Ù‰ Ø³Ø¨ÙŠÙ„ Ø§Ù„Ù…Ø«Ø§Ù„: "Ù„Ø§ ØªØªÙˆÙØ± Ù„Ø¯ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­ÙˆÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ù‚Ø·Ø© Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ¯, Ù„ÙƒÙ† ÙŠÙ…ÙƒÙ†Ùƒ Ø¥ÙŠØ¬Ø§Ø¯Ù‡Ø§ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬."

**Ø³ÙŠØ§Ù‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªÙˆÙØ± Ù„Ø¯ÙŠÙƒ:**
- **Ø§Ù„ÙØ¦Ø§Øª:** ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù…ØªØ¬Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©: ${categoryList}.${browsingHistoryContext}
- **Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:** Ø¥Ù„ÙŠÙƒ Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø±Ø¬ÙˆØ¹ Ø¥Ù„ÙŠÙ‡Ø§ (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù…Ø§Ø±ÙƒØ©ØŒ Ø§Ù„Ø³Ø¹Ø±ØŒ Ø§Ù„ÙˆØµÙØŒ ID):
${productSample}
`;
  }, [products, categories, recentlyViewedIds]);
  
  useEffect(() => {
    if (isOpen && history.length === 0) {
      const initialHistory = [
          { role: 'user', text: "Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø¹Ø±ÙÙ†ÙŠ Ø¨Ù†ÙØ³Ùƒ." },
          { role: 'model', text: "Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ ÙÙŠ World Technology. âœ¨ ÙŠÙ…ÙƒÙ†Ù†ÙŠ ØªØ²ÙˆÙŠØ¯Ùƒ Ø¨ØªÙØ§ØµÙŠÙ„ Ø¯Ù‚ÙŠÙ‚Ø© Ø¹Ù† Ù…Ù†ØªØ¬Ø§ØªÙ†Ø§ ÙˆØ®Ø¯Ù…Ø§ØªÙ†Ø§ ÙˆØªÙ‚Ø¯ÙŠÙ… ØªÙˆØµÙŠØ§Øª Ù…Ø®ØµØµØ© Ù„Ùƒ. ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ" }
      ];
      setHistory(initialHistory);
    } else if (!isOpen) {
        setHistory([]);
        setStreamingMessage(''); // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…ØªØ¯ÙÙ‚Ø© Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´Ø§Øª
    }
  }, [isOpen, history.length]);

  const handleSendMessage = async (e) => {
    e.preventDefault();
    if (!input.trim() || isLoading) return;

    const currentInput = input;
    setInput('');
    setIsLoading(true);
    setError(null);
    setStreamingMessage(''); // ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ Ø±Ø³Ø§Ù„Ø© Ù…ØªØ¯ÙÙ‚Ø© Ø³Ø§Ø¨Ù‚Ø©
    
    // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ®
    const newHistory = [...history, { role: 'user', text: currentInput }];
    setHistory(newHistory);
    
    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                history: newHistory.map(h => ({
                    role: h.role,
                    parts: [{ text: h.text }]
                })),
                message: currentInput,
                systemInstruction: systemInstruction,
            })
        });

        if (!response.ok || !response.body) {
            const errorData = await response.json().catch(() => ({ error: 'An unknown server error occurred.'}));
            throw new Error(errorData.error || `Server error: ${response.statusText}`);
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullResponse = '';

        while (true) {
            const { value, done } = await reader.read();
            if (done) break;

            const chunkText = decoder.decode(value, { stream: true });
            
            if (chunkText) {
                fullResponse += chunkText;
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…ØªØ¯ÙÙ‚Ø© ÙÙ‚Ø·
                setStreamingMessage(fullResponse);
            }
        }

        // Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©ØŒ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…ØªØ¯ÙÙ‚Ø©
        setHistory(prev => [...prev, { role: 'model', text: fullResponse }]);
        setStreamingMessage('');

    } catch (err) {
        console.error("Error sending message via API:", err);
        setError("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ù…Ø§. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
        // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ®
        setHistory(prev => [...prev, { 
            role: 'model', 
            text: "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹." 
        }]);
    } finally {
        setIsLoading(false);
        setStreamingMessage(''); // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…ØªØ¯ÙÙ‚Ø©
    }
  };

  // Ø¯Ø§Ù„Ø© Ù„Ø¯Ù…Ø¬ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ø¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…ØªØ¯ÙÙ‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  const getDisplayHistory = () => {
    if (streamingMessage && !isLoading) {
      setStreamingMessage(''); // ØªÙ†Ø¸ÙŠÙ Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆÙ„ÙƒÙ† Ø¨Ù‚ÙŠ Ù†Øµ
    }
    
    if (streamingMessage) {
      return [...history, { role: 'model', text: streamingMessage, isStreaming: true }];
    }
    return history;
  };

  return { 
    history: getDisplayHistory(), 
    setHistory, 
    input, 
    setInput, 
    isLoading, 
    error, 
    handleSendMessage, 
    chat: isOpen,
    streamingMessage 
  };
};